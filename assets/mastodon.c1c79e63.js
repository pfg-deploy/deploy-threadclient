import{e as t,r as e,m as n,a as o,o as i,b as r}from"./index.643f2d7f.js";import{e as a}from"./base.50b98d34.js";import"./vendor.f1632930.js";const l=t=>"https://"+location.host+"/login/mastodon/"+t;function s(t){return null==t||""===t?{actions:[],inboxes:[]}:{actions:[S(t)?{kind:"link",client_id:R.id,text:"Log Out",url:"TODO log out from mastodon"}:{kind:"login",client_id:R.id,data:L.encode({host:t})}],inboxes:[]}}const d=(t,e="404 not found")=>({title:"Error",navbar:s(t),body:{kind:"one",item:{parents:[{kind:"thread",title:{text:"Error"},body:{kind:"text",client_id:R.id,content:e,markdown_format:"none"},display_mode:{body:"visible",comments:"collapsed"},link:"TODO no link",layout:"error",actions:[],default_collapsed:!1,raw_value:{}}],replies:[]}},display_style:"comments-view"}),c=()=>({kind:"thread",title:{text:"Listing"},body:{kind:"text",client_id:R.id,content:"Listing",markdown_format:"none"},display_mode:{body:"collapsed",comments:"collapsed"},link:"TODO no link",layout:"error",actions:[],default_collapsed:!1,raw_value:{}});function u(t,...e){return"https://"+t+"/"+e.join("/")}async function p(t,e,n="GET"){try{const[o,i]=await fetch(e,{method:n,headers:{Accept:"application/json",...t?{Authorization:t.token_type+" "+t.access_token}:{}}}).then((async t=>[t.status,await t.json()]));return 200!==o&&console.log("got status "+o,i),i}catch(o){return{error:"Failed to load! "+o.toString()}}}function m(t,e){let n=[];return e.flatMap(((o,i)=>{var r;const a=b(t,o);let l=[];if(null!=o.in_reply_to_id){if((null==(r=e[i+1])?void 0:r.id)===o.in_reply_to_id)return n.unshift(a),[];l=[{kind:"load_more",url:"/"+t+"/statuses/"+o.in_reply_to_id,raw_value:o,load_more:F.encode({kind:"context",host:t,parent_id:o.in_reply_to_id})}]}const s=n;return n=[],[{parents:[...l,a,...s],replies:[]}]}))}function h(t,e,n){var o;const i=new Map,r={replies:[]};i.set(e,r);for(const a of n){const e=null!=(o=a.in_reply_to_id)?o:"nope";let n=i.get(e);n||(console.log("Missing parent id in reparented thread",e),alert("Reparenting error, check console"),n=r);const l=b(t,a);null!=n.replies||(n.replies=[]),n.replies.push(l),i.set(a.id,l)}return r.replies}function _(t,n){if(n instanceof HTMLElement&&"P"===n.nodeName)return e.p(...f(t,n.childNodes))}function f(t,e){return Array.from(e).flatMap((e=>y(t,e,{})))}function y(t,n,o){var i,r;if(n instanceof Text){const r=(null!=(i=n.nodeValue)?i:"[ENoNodeValue]").split(":"),a=[];let l=[];const s=()=>{l.length>0&&a.push(e.txt(l.join(":"),o)),l=[]};for(const n of r){const o=t.emojis.get(n);o?(s(),a.push(e.kind("emoji",{url:o.static_url,name:":"+n+":"}))):l.push(n)}return s(),a}if(n instanceof HTMLElement){let i=Array.from(n.classList).filter((t=>!t.startsWith("h-")&&(!t.startsWith("p-")&&!t.startsWith("u-"))));const a=t=>!!i.includes(t)&&(i=i.filter((e=>e!==t)),!0),l=(...t)=>0!==i.length?[e.error(i.map((t=>"."+t)).join(""),n.outerHTML)]:t;if("A"===n.nodeName){const i=null!=(r=n.getAttribute("href"))?r:"no href";if(!i.startsWith("http://")&&!i.startsWith("https://"))return l(e.error("Bad link",i));if(a("hashtag")){a("mention");const i=Array.from(n.childNodes).flatMap((e=>y(t,e,o))),r=n.textContent;return null!=r&&r.startsWith("#")?l(e.link(R,"/"+t.host+"/timelines/tag/"+encodeURIComponent(r),{},...i)):[e.error("bad hashtag",[i,n])]}if(a("mention")){const n=t.mentions.get(i);if(n)return l(e.link(R,"/"+t.host+"/accounts/"+n.id,{is_user_link:n.username},e.txt("@"+n.acct,o)))}return l(e.link(R,i,{},...Array.from(n.childNodes).flatMap((e=>y(t,e,o)))))}if("BR"===n.nodeName)return l(e.br());if("SPAN"===n.nodeName){const r=Array.from(n.childNodes).flatMap((e=>y(t,e,o)));return i.includes("invisible")?[]:(a("ellipsis")&&r.push(e.txt("…",o)),a("h-card"),l(...r))}return[e.error("<"+n.nodeName+">",{node:n,html:n.outerHTML})]}return[e.error("Unsupported Node",n)]}function k(t){var e;const n=el("div");return n.innerHTML=t,null!=(e=n.textContent)?e:"*no content*"}function w(t,e,n){const o=document.createElement("div");o.innerHTML=e;const i=new Map;for(const a of n.emojis)i.set(a.shortcode,a);const r=new Map;for(const a of n.mentions)r.set(a.url,a);return[{host:t,emojis:i,mentions:r},o.childNodes]}function v(t,n,o){return function(t,n){const o=[];function i(){r.length>0&&o.push(e.p(...r)),r=[]}let r=[];for(const e of Array.from(n)){const n=_(t,e);n?(i(),o.push(n)):r.push(...y(t,e,{}))}return i(),o}(...w(t,n,o))}function g(t,e,n){const[o,i]=w(t,e,n);return f(o,i)}function b(t,n,o={}){try{return function(t,e,n={}){var o;const r={time:new Date(e.created_at).getTime(),edited:!1,author:{name:e.account.display_name+" (@"+e.account.acct+")",client_id:R.id,color_hash:e.account.username,link:"/"+t+"/accounts/"+e.account.id,flair:e.account.bot?[{elems:[{kind:"text",text:"bot"}],content_warning:!1}]:[],pfp:{url:e.account.avatar_static,hover:e.account.avatar}},reblogged_by:n.reblogged_by,pinned:!1};if(e.reblog)return b(t,e.reblog,{...n,reblogged_by:r});return{kind:"thread",body:{kind:"array",body:[{kind:"richtext",content:v(t,e.content,{emojis:e.emojis,mentions:e.mentions})},0===e.media_attachments.length?void 0:{kind:"gallery",images:e.media_attachments.map((t=>function(t,e){var n,o,i,r,a,l,s,d,c,u,p,m;return"image"===e.type?{thumb:null!=(n=e.preview_url)?n:"https://dummyimage.com/100x100/ff0000/000000&text=image",aspect:(null==(o=e.meta)?void 0:o.small)?e.meta.small.width/e.meta.small.height:void 0,body:e.meta?{kind:"captioned_image",url:e.url,w:null!=(r=null==(i=e.meta.original)?void 0:i.width)?r:null,h:null!=(l=null==(a=e.meta.original)?void 0:a.height)?l:null,alt:e.description}:{kind:"link",url:e.url,client_id:R.id}}:"video"===e.type||"gifv"===e.type?{thumb:null!=(s=e.preview_url)?s:"https://dummyimage.com/100x100/ff0000/000000&text=video",aspect:(null==(d=e.meta)?void 0:d.small)?e.meta.small.width/e.meta.small.height:void 0,body:e.meta?{kind:"video",source:{kind:"video",sources:[{url:e.url,quality:(null==(c=e.meta.original)?void 0:c.width)+"×"+(null==(u=e.meta.original)?void 0:u.width)}]},aspect:e.meta.original?e.meta.original.width/e.meta.original.height:void 0,gifv:"gifv"===e.type}:{kind:"link",url:e.url,client_id:R.id}}:"audio"===e.type?{thumb:null!=(p=e.preview_url)?p:"https://winaero.com/blog/wp-content/uploads/2017/12/speaker-sound-audio-icon-256-big.png",aspect:1,body:{kind:"audio",url:e.url,alt:e.description}}:"unknown"===e.type?{thumb:null!=(m=e.preview_url)?m:"https://dummyimage.com/100x100/ff0000/000000&text=unknown",aspect:1,body:{kind:"array",body:[{kind:"text",client_id:R.id,content:"alt: "+e.description,markdown_format:"none"},{kind:"link",client_id:R.id,url:e.url},...null!=e.remote_url?[{kind:"link",client_id:R.id,url:e.remote_url}]:[]]}}:(e.type,{thumb:"https://dummyimage.com/100x100/ff0000/000000&text="+encodeURIComponent(e.type),aspect:1,body:{kind:"link",client_id:R.id,url:e.url}})}(0,t)))},e.poll?{kind:"poll",choices:e.poll.options.map(((t,e)=>({name:t.title,votes:t.votes_count,id:""+e}))),total_votes:e.poll.votes_count,votable:!e.poll.expired||"Expired",vote_data:e.poll.id,select_many:e.poll.multiple,your_votes:(null!=(o=e.poll.own_votes)?o:[]).map((t=>({id:""+t}))),close_time:new Date(e.poll.expires_at).getTime()}:void 0,e.card?i(e.card,R.id):void 0]},display_mode:{body:"visible",comments:"visible"},link:"/"+t+"/statuses/"+e.id,layout:"mastodon-post",info:r,flair:e.sensitive||e.spoiler_text?[{content_warning:e.sensitive,elems:[{kind:"text",text:e.spoiler_text||"Sensitive"}]}]:void 0,actions:[{kind:"link",client_id:R.id,url:"/"+t+"/statuses/"+e.id,text:e.replies_count+" repl"+(1===e.replies_count?"y":"ies")},{kind:"link",client_id:R.id,url:e.uri,text:"Permalink"},{kind:"counter",label:"Favourite",client_id:R.id,incremented_label:"Favourited",unique_id:t+"/favourite/"+e.id+"/",time:Date.now(),count_excl_you:e.favourites_count+(e.favourited?-1:0),you:e.favourited?"increment":void 0,actions:{increment:N.encode({kind:"favourite",direction:"",status:e.id,host:t}),reset:N.encode({kind:"favourite",direction:"un",status:e.id,host:t})}}],default_collapsed:!1,raw_value:e,replies:n.replies}}(t,n,o)}catch(r){return{kind:"thread",title:{text:"Error!"},body:{kind:"richtext",content:[e.p(e.error("Error "+r.toString(),r))]},display_mode:{body:"visible",comments:"collapsed"},link:"/"+t+"/statuses/"+n.id,layout:"reddit-post",default_collapsed:!1,actions:[],raw_value:[t,n,o]}}}function x(t,e){const[n,o]=function(t){const[e,...n]=t.split("?");return[null!=e?e:"",new URLSearchParams(n.join("?"))]}(t);for(const[i,r]of Object.entries(e))null!=r?o.set(i,r):o.delete(i);return n+"?"+o.toString()}function E(e,n){return"raw!https://"+e+"/oauth/authorize?"+t({client_id:n.client_id,scope:"read write follow push",redirect_uri:l(e),response_type:"code"})}function j(t){return{get(e){if(!e)return;const n=localStorage.getItem(t(e));return null!=n&&""!==n?JSON.parse(n):void 0},set(e,n){if(!e)throw console.log(e,n),alert("bad set. check console."),new Error("set performed with no host");localStorage.setItem(t(e),JSON.stringify(n))}}}const T={app:j((t=>"mastodon-application-"+t)),token:j((t=>"mastodon-secret-"+t)),client_creds:j((t=>"mastodon-client-secret-"+t)),client_did_error:j((t=>"mastodon-client-did-error-"+t))},N=a("act");function S(t){return!!T.token.get(t)}async function O(t){var e,n;if(!t)return;const o=null!=(e=T.token.get(t))?e:T.client_creds.get(t);if(!o){const e=T.app.get(t);if(!e||null!=(n=T.client_did_error.get(t))&&n)return;const{data:o}=e,i=await fetch(u(t,"oauth","token"),{method:"post",mode:"cors",credentials:"omit",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({client_id:o.client_id,client_secret:o.client_secret,redirect_uri:l(t),grant_type:"client_credentials"})}).then((t=>t.json()));return"error"in i?(T.client_did_error.set(t,!0),console.log(i),void alert("failed to get application token. will not try again. :: "+i.error)):(T.client_creds.set(t,i),i)}return o}function M(t,e,n){return{title:e,navbar:s(null),body:{kind:"one",item:{parents:[{kind:"thread",body:n,display_mode:{body:"visible",comments:"collapsed"},raw_value:null,link:"/",layout:"reddit-post",actions:[],default_collapsed:!1}],replies:[]}},display_style:"comments-view"}}const A=r();A.with([{host:"any"}],(e=>{e.route(["raw",{path:"rest"}],(e=>({kind:"raw",path:"/"+e.path.join("/")+"?"+t(e.query),host:e.host}))),e.route([],(t=>({kind:"instance-home",host:t.host}))),e.with(["timelines"],(e=>{e.route(["home"],(e=>({kind:"timeline",tmname:"home",api_path:"/api/v1/timelines/home?"+t(e.query),host:e.host}))),e.route(["public","local"],(e=>({kind:"timeline",tmname:"local",api_path:"/api/v1/timelines/public?"+t({...e.query,local:"true"}),host:e.host}))),e.route(["public"],(e=>({kind:"timeline",tmname:"public",api_path:"/api/v1/timelines/public?"+t({...e.query,local:"false"}),host:e.host}))),e.route(["local"],(e=>({kind:"timeline",tmname:"local",api_path:"/api/v1/timelines/public?"+t({...e.query,local:"true"}),host:e.host}))),e.route(["tag",{hashtag:"any"}],(e=>({kind:"timeline",tmname:"tag",api_path:"/api/v1/timelines/tag/"+e.hashtag+"?"+t(e.query),host:e.host}))),e.catchall((t=>({kind:"404",reason:"Unsupported timeline",host:t.host})))})),e.route(["statuses",{statusid:"any"}],(t=>({kind:"status",status:t.statusid,host:t.host}))),e.route(["accounts",{accountid:"any"}],(e=>({kind:"account",account:e.accountid,host:e.host,api_url:"/api/v1/accounts/"+e.accountid+"/statuses?"+t({...e.query})}))),e.route(["notifications"],(t=>({kind:"notifications",host:t.host}))),e.catchall((t=>({kind:"404",reason:"Not Found",host:t.host})))})),A.catchall((()=>({kind:"instance-selector"})));const L=a("login_url"),R={id:"mastodon",getLoginURL:async t=>{const{host:e}=L.decode(t);if(null==e)throw new Error("can't login without selecting host first");const n=T.app.get(e);if(n){if(n.host!==e)throw new Error("This should never happen.");return E(e,n.data)}const o=await fetch(u(e,"api/v1","apps"),{method:"post",mode:"cors",credentials:"omit",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({client_name:"ThreadClient",redirect_uris:l(e),scopes:"read write follow push",website:"https://thread.pfg.pw"})}).then((t=>t.json()));if("error"in o)throw console.log(o),new Error("Got error:"+o.error);return T.app.set(e,{host:e,data:o}),E(e,o)},login:async(t,e)=>{if(2!==t.length)throw new Error("bad login");const n=t[1],o=e.get("code");if(null==o)throw new Error("missing code");const i=T.app.get(n);if(!i)throw new Error("An app was not registered - how did you even get here?");const{data:r}=i,a=await fetch(u(n,"oauth","token"),{method:"post",mode:"cors",credentials:"omit",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({client_id:r.client_id,client_secret:r.client_secret,redirect_uri:l(n),grant_type:"authorization_code",code:o,scope:"read write follow push"})}).then((t=>t.json()));if("error"in a)throw console.log(a),new Error("Got error (check console): "+a.error);T.token.set(n,a),console.log(a)},getThread:async t=>{var i,r,a,l,m,_,f,y,w,x;const E=null!=(i=A.parse(t))?i:{kind:"404",reason:"This should never happen"};if("instance-selector"===E.kind)return M(0,"Choose Instance",{kind:"mastodon_instance_selector",client_id:R.id});if("404"===E.kind)return d("",E.reason);const j=E.host,T=await O(j);if("instance-home"===E.kind)return M(0,"Links | "+j,{kind:"richtext",content:[e.h1(e.txt(j)),e.ul(...[["/"+j+"/timelines/public","Federated Timeline"],["/"+j+"/timelines/local","Local Timeline"]].map((([t,n])=>e.li(e.p(e.link(R,t,{},e.txt(n)))))))]});if("timeline"===E.kind){const e=[n.link(R,"Home","/"+j+"/timelines/home","home"===E.tmname),n.link(R,"Local","/"+j+"/timelines/local","local"===E.tmname),n.link(R,"Federated","/"+j+"/timelines/public","public"===E.tmname),n.link(R,"Notifications","/"+j+"/notifications",!1)];return await C(j,T,E.api_path,t,c(),e,"Timeline "+E.tmname)}if("status"===E.kind){const[t,e]=await Promise.all([p(T,u(j,"api/v1","statuses",E.status)),p(T,u(j,"api/v1","statuses",E.status,"context"))]);return"error"in t?d(j,"Error! "+t.error):"error"in e?d(j,"Error! "+e.error):{title:t.account.acct+' on Mastodon: "'+k(t.content)+'"',navbar:s(j),body:{kind:"one",item:{parents:[...e.ancestors.map((t=>b(j,t))),b(j,t)],replies:[...h(j,t.id,e.descendants)]}},display_style:"comments-view"}}if("account"===E.kind){const n=E.account,[o,i]=await Promise.all([p(T,u(j,"api/v1","accounts",n)),p(T,u(j,"api/v1/accounts/relationships/?id[]="+n))]);if("error"in o)return d(j,"Error! "+o.error);"error"in i&&console.log(i);const s=("error"in i?[]:i).find((t=>t.id===n)),c={emojis:null!=(r=o.emojis)?r:[],mentions:null!=(a=o.mentions)?a:[]};return await C(j,T,E.api_url,t,{kind:"bio",banner:{desktop:null!=(m=null!=(l=o.header_static)?l:o.header)?m:"none"},icon:{url:null!=(f=null!=(_=o.avatar_static)?_:o.avatar)?f:"none"},name:{display:o.display_name,link_name:o.acct},body:{kind:"richtext",content:[...v(j,o.note,c),e.table([e.th(void 0,e.txt("Key")),e.th(void 0,e.txt("Value")),e.th(void 0,e.txt("V"))],...o.fields.map((t=>[e.td(e.txt(t.name)),e.td(...g(j,t.value,c)),e.td(e.txt(null!=t.verified_at?"✓":"✗"))])))]},subscribe:{kind:"counter",client_id:R.id,unique_id:"/follow/"+o.id+"/",time:Date.now(),label:o.locked?"Request Follow":"Follow",incremented_label:"Following",count_excl_you:-1===o.followers_count?"hidden":o.followers_count+(null!=(y=null==s?void 0:s.following)&&y?-1:0),you:null!=(w=null==s?void 0:s.following)&&w?"increment":void 0,style:"pill-filled",incremented_style:"pill-empty",actions:{increment:N.encode({kind:"follow",account_id:o.id,host:j,direction:""}),reset:N.encode({kind:"follow",account_id:o.id,host:j,direction:"un"})}},more_actions:[{kind:"link",client_id:R.id,url:o.url,text:"Permalink"}],menu:null,raw_value:o},[],(null!=(x=o.display_name)?x:"")+" ("+o.acct+")")}if("notifications"===E.kind){const t=await p(T,u(j,"api/v1/notifications"));if("error"in t)return d("error: "+t.error);const e={follow:"Someone followed you",follow_request:"Someone requested to follow you",mention:"Someone mentioned you in a status",reblog:"Someone reblogged your status",favourite:"Someone favourited your status",poll:"A poll you interacted with has ended",status:"Smomeone you have notifications on for posted a status",unsupported:"Unsupported notification type. Error."};return{title:"Notifications",navbar:s(j),body:{kind:"listing",header:c(),menu:void 0,items:t.map((t=>{var n;return{parents:[{kind:"thread",title:{text:null!=(n=e[t.type])?n:e.unsupported},body:{kind:"none"},display_mode:{body:"visible",comments:"collapsed"},link:"/"+j+"/notifications/"+t.id,layout:"reddit-post",default_collapsed:!1,actions:[],raw_value:t},...t.status?[b(j,t.status)]:[]],replies:[]}})),next:void 0},display_style:"comments-view"}}if("raw"===E.kind){const t=await p(T,"https://"+j+E.path);return{title:"Error View",navbar:s(j),body:{kind:"one",item:{parents:[{kind:"thread",raw_value:t,body:{kind:"richtext",content:[e.pre(JSON.stringify(t,null,"\t"),"json")]},display_mode:{body:"visible",comments:"visible"},link:E.path,layout:"error",actions:[],default_collapsed:!1}],replies:[]}},sidebar:[{kind:"widget",title:"Raw",widget_content:{kind:"body",body:{kind:"richtext",content:[e.p(e.txt("This is a raw page.")),e.p(e.link(R,E.path,{},e.txt("View Rendered")))]}},raw_value:E}],display_style:"comments-view"}}o(E)},async act(t){const e=N.decode(t);"favourite"===e.kind?await q(e.host,"api/v1/statuses/"+e.status+"/"+e.direction+"favourite"):"follow"===e.kind?await q(e.host,"api/v1/accounts/"+e.account_id+"/"+e.direction+"follow"):function(t){throw console.log(t),new Error("Expected unreachable: "+t)}(e)},previewReply(t,e){throw new Error("TODO")},sendReply(t,e){throw new Error("NIY")},async loadMore(t){throw new Error("not used")},async loadMoreUnmounted(t){const e=D.decode(t),n=await O(e.tl_info.host),o=await C(e.tl_info.host,n,e.tl_info.api_path,e.tl_info.web_path,c(),[],"*unused*");if("listing"===o.body.kind)return{children:o.body.items,next:o.body.next};throw console.log("ERROR got",o),new Error("TODO support "+o.body.kind)}};async function q(t,e){const n=await O(t),o=await p(n,u(t,e),"POST");if("error"in o)throw console.log(o),new Error("Got error: "+o.error)}async function C(t,e,n,o,i,r,a){const l=u(t,n),c=await p(e,l);if("error"in c)return d("Error! "+c.error);const h=c[c.length-1];let _;if(h){const e=x("/"+t+o,{since_id:void 0,min_id:void 0,max_id:h.id}),i=x(n,{since_id:void 0,min_id:void 0,max_id:h.id});_={kind:"load_more_unmounted",load_more_unmounted:D.encode({kind:"timeline",tl_info:{host:t,api_path:i,web_path:e}}),url:e,raw_value:h}}return{title:a,navbar:s(t),body:{kind:"listing",header:i,menu:r,items:m(t,c),next:_},display_style:"comments-view"}}const D=a("load_more_unmounted"),F=a("load_more");export{R as client};
