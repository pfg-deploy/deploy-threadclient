import{Q as te,c as w,H as W,U as re,z as ie,i as f,a as _,d as Y,n as A,G as z,m as F,V as le,f as v,W as se,X as H,e as R,Y as I,t as g,o as oe,J as O,Z as G,_ as ae,T as Q,q as ce,$ as ue}from"./index.e666e6a6.js";function h(e){return e!=null&&typeof e=="object"}function b(e){return h(e)?e:null}function j(){throw new Error("Expected unreachable")}function k(){return te(Date.now(),{readBytes:e=>crypto.getRandomValues(e)})}const X=Symbol("value"),S=Symbol("path"),N=Symbol("root"),de={get(e,n,r){return typeof n!="string"?Reflect.get(e,n,r):Z(U(e),[...e[S],n])},ownKeys(e){const n=Reflect.ownKeys(e);return n.some(r=>typeof r!="symbol")&&j(),[...n,...P(e)]}};function Z(e,n){const r={[X]:void 0,[S]:[...n],[N]:e};return new Proxy(r,de)}function E(e){const n=J(e);if(typeof n=="object"){const r={};for(const t of P(e))r[t]=E(e[t]);return r}else return n}function P(e){const n=V(e[N],e[S]);return M(e[N],[...e[S],{v:"keys"}]).view(),Object.keys(b(n)??{})}function J(e){const n=V(e[N],e[S]);return h(n)?{__is_object:!0}:n}function x(e){const n=J(e);return typeof n=="string"?n:null}function fe(e){const n=J(e);return typeof n=="boolean"?n:null}function $(e,n,r){return _e(e,n,r)}function _e(e,n,r){r||(r={undo_group:pe()},ge(U(e),r.undo_group)),Ne(U(e),r.undo_group,e[S],n)}class me{constructor(){this.action_ids=[]}}function pe(){return new me}function ge(e,n){const r=[...e.undos];r.splice(e.undo_index,1/0,n),e.undos=r,e.undo_index=e.undos.length,e.undos_signal[1](void 0)}function U(e){return e[N]}function L(e,n,r){const t={parent:{r:{...b(n)??{}}},key:"r"};let l=t;for(const s of e){if(!Object.hasOwnProperty.call(l.parent,l.key))return n;const i=l.parent[l.key];if(!h(i))return n;const o={...i};l.parent[l.key]=o,l={parent:o,key:s}}return Object.hasOwnProperty.call(l.parent,l.key)?(l.parent[l.key]=r(l.parent[l.key]),t.parent[t.key]):n}function ye(e,n){const r=e.value;if(r.kind==="set_value")return L(r.path,n,t=>r.new_value);if(r.kind==="reorder_keys")return L(r.path,n,t=>{const l=b(t)??{},s=Object.keys(l),i=r.old_keys,o=new Set(i);for(const u of s)o.delete(u);const c=new Set(s);for(const u of i)c.delete(u);return Object.fromEntries([...c,...r.new_keys].map(u=>[u,l[u]]))});if(r.kind==="undo")throw new Error("Internal error; Undos should not be sent to applyAction()");ie(r)}function he(){const e={watched_nodes:new Map,all_contents:new Set,permanent_actions:[],temporary_actions:[],snapshot:null,snapshots:new Map,actions_signal:w(void 0,{equals:()=>!1}),undos:[],undo_index:0,undos_signal:w(void 0,{equals:()=>!1}),performance:w(null)};return Z(e,[])}function M(e,n){const r=JSON.stringify(n);let t=e.watched_nodes.get(r);return t||(t=w(void 0,{equals:()=>!1}),e.watched_nodes.set(r,t)),{view:()=>{t[0]()},emit:()=>{t[1](void 0)}}}function V(e,n){M(e,n).view();let t=e.snapshot;for(const l of n)if(h(t))t=t[l];else{t=void 0;break}return t}function be(e,n){const r=[];for(const[t,l]of e.entries()){const s=e.slice(0,t),i=P({[X]:null,[S]:s,[N]:n});i.includes(l)||r.push({id_type:"temporary",temporary_id:k(),last_updated:k(),value:{kind:"reorder_keys",old_keys:i,new_keys:[...i,l],path:s},affects_tree:s})}return r}function ee(e,n,r){if(n===r)return[];if(!h(r))return[{id_type:"temporary",temporary_id:k(),last_updated:k(),value:{kind:"set_value",new_value:r,path:e},affects_tree:e}];const t=[],l=Object.keys(b(n)??{}),s=Object.keys(r);(JSON.stringify(l)!==JSON.stringify(s)||!h(n))&&t.push({id_type:"temporary",temporary_id:k(),last_updated:k(),value:{kind:"reorder_keys",old_keys:l,new_keys:s,path:e},affects_tree:e});for(const i of s)t.push(...ee([...e,i],(b(n)??{})[i],r[i]));return t}function T(e){return e[e.length-1]}function ve(e,n){return e===n?0:e<n?-1:1}function ne(e,n){return e==null?!1:typeof e=="number"?typeof n=="number"?e<n:!0:typeof n=="number"?!1:e<n}function ke(e,n){return ne(e,n)?e:n}function q(e){return e.id_type==="permanent"?e.permanent_id:e.last_updated}function $e(e){return e.id_type==="permanent"?e.permanent_id:e.temporary_id}function K(e,n){const r=[...n].sort((a,d)=>ve(a.temporary_id,d.temporary_id));let t=null;const l=a=>{t=ke(t,a)},s=a=>e.has(q(a)),i=a=>{const d=q(a);if(e.has(d))return e.get(d);console.error("did not find a snapshot for",a,e),j()},o=new Set;let c=r.length-1;for(;c>=0;c--){const a=r[c];a||j();const d=$e(a);if(!o.has(a.temporary_id)){if(a.value.kind==="undo"){for(const p of a.value.ids)o.add(p);l(a.value.earliest_referenced_server_action??-1)}if((t==null||ne(d,t))&&s(a)){console.log("snapshot available!",d,c,"!");break}}}c===-1&&console.log("no snapshot available, rebuilding from scratch\u2026");let u=c===-1?null:i(r[c]);for(c=c+1;c<r.length;c++){const a=r[c];a||j(),!o.has(a.temporary_id)&&a.value.kind!=="undo"&&(u=ye(a,u))}return u}function we(e){let n=!1;const t=T(e.permanent_actions)?.permanent_id;t!=null&&!e.snapshots.has(t)&&(e.snapshots.set(t,K(e.snapshots,e.permanent_actions)),n=!0);const s=T(e.temporary_actions)?.last_updated;if(s!=null&&!e.snapshots.has(s)&&(e.snapshots.set(s,K(e.snapshots,[...e.permanent_actions,...e.temporary_actions])),n=!0),n){const i=t!=null?e.snapshots.get(t):null,o=s!=null?e.snapshots.get(s):null;e.snapshots=new Map([...t!=null?[[t,i]]:[],...s!=null?[[s,o]]:[]])}return e.snapshots.get(T(e.temporary_actions)?.last_updated??T(e.permanent_actions)?.permanent_id??void 0)??null}function xe(e,{temporary:n,permanent:r}){if(n.length===0&&r.length===0)return;e.temporary_actions.push(...n);const t=new Set;for(const i of e.permanent_actions)t.add(i.permanent_id);const l=new Set;for(const i of r)l.add(i.temporary_id);for(const i of r)t.has(i.permanent_id)||((T(e.permanent_actions)?.permanent_id??-1)>i.permanent_id&&j(),e.permanent_actions.push(i));let s=!1;e.temporary_actions=e.temporary_actions.flatMap(i=>l.has(i.temporary_id)?(s=!0,[]):s?[{...i,last_updated:k()}]:[i]),W(()=>{const i=e.snapshot,o=we(e);e.snapshot=o;const c=D([],i,o);re(()=>{Ce(e,c),e.actions_signal[1](void 0)})})}function Se(e,n,r){n.action_ids.push(...r.map(t=>t.temporary_id)),xe(e,{temporary:r,permanent:[]})}function Ne(e,n,r,t){W(()=>{const l=V(e,r),s=t(l),i=[...be(r,e),...ee(r,l,s)];Se(e,n,i)})}function D(e,n,r){if(n===r)return[];const t=[],l=h(n)?Object.keys(n):[],s=h(r)?Object.keys(r):[],i=new Set(l);for(const o of s)i.delete(o);if(h(r)){const o=b(n)??{};for(const c of s)t.push(...D([...e,c],o[c],r[c]))}JSON.stringify(l)!==JSON.stringify(s)&&t.push([...e,{v:"keys"}]);{const o=b(n)??{},c=b(r)??{};for(const u of i)t.push(...D([...e,u],o[u],c[u]))}return h(n)&&h(r)||t.push(e),t}function Ce(e,n){for(const r of n)M(e,r).emit()}const C=g("<div></div>"),Oe=g('<h1 class="mb-4"> | Warning: if you navigate away, you will lose any entered text | Post submission is also currently <!>.</h1>'),Te=g('<div class="flex flex-wrap gap-4"><button></button></div>'),je=g('<p class="text-red-500 mb-4"></p>'),Ae=g('<div><div class="mb-4"></div></div>'),Re=g("<button>Cancel</button>"),ze=g("<button>Code</button>"),Ee=g('<div><label><div class="sr-only">Title</div><input class="w-full bg-slate-300 dark:bg-zinc-900 text-xl font-black p-2 placeholder-slate-600 dark:placeholder-zinc-400 placeholder:font-normal" placeholder="Title"></label></div>'),Ue=g('<div><ul class="flex flex-wrap flex-row gap-4"><label class="select-none"><input type="radio"> (no flair)</label></ul></div>'),De=g('<li><label><input type="radio"> </label></li>'),Ie=g('<div><ul class="flex flex-wrap flex-row gap-4"></ul></div>'),Pe=g('<li><label class="select-none"><input type="checkbox"> </label></li>'),Je=g('<div><div class="flex flex-row flex-wrap"></div></div>'),Me=g(`<textarea class="
                        block w-full rounded-none rounded-bl-lg resize-y
                        placeholder-slate-600 dark:placeholder-zinc-400
                        bg-slate-300 dark:bg-zinc-900 p-2
                    " rows="4"></textarea>`),Ve=g(`<div class="
                    block w-full rounded-none rounded-b-lg
                    bg-transparent border-2 border-slate-200 dark:border-zinc-700 p-2
                "></div>`),Be=g('<div class="pt-2"><div class="bg-slate-400 dark:bg-zinc-700 rounded-t-lg p-1 pb-0 flex flex-row flex-wrap gap-2"></div></div>'),Fe=g('<div class="pt-2"><label><div class="sr-only">URL</div><input class="w-full bg-slate-300 dark:bg-zinc-900 p-2 placeholder-slate-600 dark:placeholder-zinc-400" placeholder="https://\u2026"></label></div>'),Ge=g("<div><div></div></div>");function Ze(e){const n=he(),r=oe(),[t,l]=w(!0),[s,i]=w({kind:"none",error:null}),o=async()=>{const u=await ue(e.submit.client_id);if(!u)throw new Error("no client");if(!u.submit)throw new Error("client does not support submitting posts");return await u.submit(e.submit.submit_key,E(n))},c=()=>{i({kind:"sending"}),o().then(u=>{i({kind:"sent",url:u})}).catch(u=>{setTimeout(()=>{i({kind:"none",error:u.toString()})},200)})};return(()=>{const u=C.cloneNode(!0);return f(u,_(I,{get item(){return s()},children:{none:a=>[(()=>{const d=Oe.cloneNode(!0),p=d.firstChild,m=p.nextSibling;return m.nextSibling,f(d,()=>e.submit.title,p),f(d,_(Y,{action:{client_id:"",url:"https://github.com/pfgithub/threadclient/issues/7"},class:"text-blue-600 dark:text-blue-400 underline",children:"missing some features"}),m),d})(),_(A,{get when(){return a.error},children:d=>(()=>{const p=je.cloneNode(!0);return f(p,d),p})()}),_(z,{get each(){return e.submit.fields},children:(d,p)=>(()=>{const m=Ae.cloneNode(!0),y=m.firstChild;return f(m,_(Ke,{get node(){return n.fields[d.id]},field:d}),y),m})()}),(()=>{const d=Te.cloneNode(!0),p=d.firstChild;return p.$$click=c,f(p,()=>e.submit.send_name),f(d,(()=>{const m=F(()=>!!e.cancel_enabled,!0);return()=>m()?(()=>{const y=Re.cloneNode(!0);return le(y,"click",e.cancel_enabled,!0),y})():null})(),null),f(d,(()=>{const m=F(()=>r.dev.showLogButtons()==="on",!0);return()=>m()?(()=>{const y=ze.cloneNode(!0);return y.$$click=()=>console.log(E(n)),y.disabled=!1,y})():null})(),null),v(m=>{const y=(t()?"bg-blue-400":"bg-slate-400 dark:bg-zinc-100")+" rounded-md text-slate-900 py-1 px-3",B=!t();return y!==m._v$&&(p.className=m._v$=y),B!==m._v$2&&(p.disabled=m._v$2=B),m},{_v$:void 0,_v$2:void 0}),d})()],sending:()=>["Submitting\u2026"," ",_(se,{class:"fa-solid fa-spinner animate-spin",label:"spinner"})],sent:a=>_(H,{get body(){return{kind:"richtext",content:[R.p(R.txt("Submitted! "),R.link({id:e.submit.client_id},a.url,{},R.txt(a.url)))]}},autoplay:!1})}})),u})()}function Le(e){return e.kind==="link"?"Link":e.kind==="text"?"Text":e.kind==="none"?"None":e.kind==="todo"?e.title:"todo["+e.kind+"]"}let qe=0;function Ke(e){const n=""+qe++;return(()=>{const r=C.cloneNode(!0);return f(r,_(I,{get item(){return e.field},children:{title:()=>(()=>{const t=Ee.cloneNode(!0),l=t.firstChild,s=l.firstChild,i=s.nextSibling;return i.$$input=o=>{$(e.node.title,()=>o.currentTarget.value)},v(()=>i.value=x(e.node.title)??""),t})(),content:t=>(()=>{const l=C.cloneNode(!0);return f(l,_(We,{get default_id(){return t.default_id},get node(){return e.node.content},get content_types(){return t.content_types}})),l})(),flair_one:t=>(()=>{const l=Ue.cloneNode(!0),s=l.firstChild,i=s.firstChild,o=i.firstChild;return o.$$input=c=>{c.currentTarget.checked&&$(e.node.flair_one,()=>null)},O(o,"name",n),f(s,_(z,{get each(){return t.flairs},children:c=>(()=>{const u=De.cloneNode(!0),a=u.firstChild,d=a.firstChild;return d.nextSibling,d.$$input=p=>{p.currentTarget.checked&&$(e.node.flair_one,()=>c.id)},O(d,"name",n),f(a,_(G,{get flairs(){return c.flairs}}),null),v(()=>d.checked=x(e.node.flair_one)===c.id),u})()}),null),v(()=>o.checked=x(e.node.flair_one)==null),l})(),flair_many:t=>(()=>{const l=Ie.cloneNode(!0),s=l.firstChild;return f(s,_(z,{get each(){return t.flairs},children:i=>(()=>{const o=Pe.cloneNode(!0),c=o.firstChild,u=c.firstChild;return u.nextSibling,u.$$input=a=>{$(e.node.flair_many[i.id],()=>a.currentTarget.checked)},O(u,"name",n),f(c,_(G,{get flairs(){return i.flairs}}),null),v(a=>{const d=i.disabled!=null?i.disabled:void 0,p=i.id,m=fe(e.node.flair_many[i.id])??!1,y=i.disabled!=null;return d!==a._v$3&&O(c,"title",a._v$3=d),p!==a._v$4&&(u.value=a._v$4=p),m!==a._v$5&&(u.checked=a._v$5=m),y!==a._v$6&&(u.disabled=a._v$6=y),a},{_v$3:void 0,_v$4:void 0,_v$5:void 0,_v$6:void 0}),o})()})),l})()}})),r})()}function We(e){const n=()=>x(e.node.tab)??e.default_id,r=ae(()=>{const t=n(),l=e.content_types.find(s=>s.id===t);return l==null?null:{node:e.node.choices[t],ct:l}});return(()=>{const t=Je.cloneNode(!0),l=t.firstChild;return f(l,_(Q,{get value(){return n()},setValue:s=>$(e.node.tab,()=>s),get choices(){return e.content_types.map(s=>[s.id,Le(s)])}})),f(t,_(A,{get when(){return r()},get fallback(){return"error: no tab selected"},children:s=>_(A,{get when(){return s.ct.disabled},get fallback(){return _(Ye,{get node(){return s.node},get content(){return s.ct}})},children:i=>(()=>{const o=C.cloneNode(!0);return f(o,i),o})()})}),null),t})()}function Ye(e){const[n,r]=w("edit");return _(I,{get item(){return e.content},children:{text:t=>(()=>{const l=Be.cloneNode(!0),s=l.firstChild;return f(s,_(Q,{get value(){return n()},setValue:i=>r(()=>i??"edit"),choices:[["edit","Edit"],["preview","Preview"]]})),f(l,_(A,{get if(){return n()==="edit"},get children(){const i=Me.cloneNode(!0);return i.$$input=o=>{$(e.node.text,()=>o.currentTarget.value)},v(o=>{const c=He(t),u=x(e.node.text)??"";return c!==o._v$7&&O(i,"placeholder",o._v$7=c),u!==o._v$8&&(i.value=o._v$8=u),o},{_v$7:void 0,_v$8:void 0}),i}}),null),f(l,_(A,{get if(){return n()==="preview"},get children(){const i=Ve.cloneNode(!0);return f(i,_(Qe,{textcontent:t,get value(){return x(e.node.text)??""}})),i}}),null),l})(),link:t=>(()=>{const l=Fe.cloneNode(!0),s=l.firstChild,i=s.firstChild,o=i.nextSibling;return o.$$input=c=>{$(e.node.link,()=>c.currentTarget.value)},v(()=>o.value=x(e.node.link)??""),l})(),todo:t=>(()=>{const l=Ge.cloneNode(!0),s=l.firstChild;return f(s,()=>t.reason),f(l,_(Y,{class:"text-blue-600 dark:text-blue-400 underline",get action(){return{url:t.linkout,client_id:t.client_id}},get children(){return t.linkout_label}}),null),l})(),none:()=>C.cloneNode(!0)}})}function He(e){return e.mode==="reddit"?"Content. You can use markdown, *like this*.":e.mode==="none"?"Content.":"Content. \xAB"+e.mode+"\xBB"}function Qe(e){return(()=>{const n=C.cloneNode(!0);return f(n,_(H,{get body(){return{kind:"text",content:e.value,markdown_format:e.textcontent.mode,client_id:e.textcontent.client_id}},autoplay:!1})),n})()}ce(["click","input"]);export{Ze as default};
